<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lista de Supermercado Familiar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
            line-height: 1.4;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .main-content {
            padding: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-buttons::-webkit-scrollbar {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
            min-width: fit-content;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn.shopping-mode {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        }

        .btn.edit-mode {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .categories {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
        }

        .category.dairy { border-left-color: #ffd93d; }
        .category.meat { border-left-color: #ff6b6b; }
        .category.vegetables { border-left-color: #4ecdc4; }
        .category.fruits { border-left-color: #45b7d1; }
        .category.grains { border-left-color: #f9ca24; }
        .category.beverages { border-left-color: #6c5ce7; }
        .category.cleaning { border-left-color: #a29bfe; }
        .category.others { border-left-color: #fd79a8; }

        .category h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 48px;
            position: relative;
        }

        .item:active {
            transform: scale(0.98);
        }

        .item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .item.completed {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-color: #11998e;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .item-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .item-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .item-quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: inherit;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .quantity-btn:active {
            transform: scale(0.9);
        }

        .item:not(.selected) .quantity-btn {
            background: #e9ecef;
            color: #333;
        }

        .quantity-display {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95rem;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 15px;
        }

        .item:not(.selected) .quantity-display {
            background: #f8f9fa;
            color: #333;
        }

        .item-status {
            font-size: 1.3rem;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .item-remove {
            background: #dc3545;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .edit-mode .item-remove {
            display: flex;
        }

        .item-remove:active {
            transform: scale(0.9);
        }

        .add-custom-item {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-custom-item input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .add-custom-item button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            min-width: 45px;
            touch-action: manipulation;
        }

        .add-custom-item button:active {
            transform: scale(0.95);
        }

        .saved-lists {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .saved-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .saved-list:active {
            transform: scale(0.98);
        }

        .saved-list h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .saved-list-meta {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .saved-list-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .saved-item {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            font-size: 0.85rem;
        }

        .saved-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .saved-item-quantity {
            background: #e9ecef;
            color: #333;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .saved-item.completed .saved-item-quantity {
            background: #c3e6cb;
        }

        .list-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .delete-list-btn, .shop-list-btn, .edit-list-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            touch-action: manipulation;
            flex: 1;
            min-width: 100px;
        }

        .delete-list-btn {
            background: #dc3545;
            color: white;
        }

        .shop-list-btn {
            background: #ff9a56;
            color: white;
        }

        .edit-list-btn {
            background: #f39c12;
            color: white;
        }

        .delete-list-btn:active, .shop-list-btn:active, .edit-list-btn:active {
            transform: scale(0.95);
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 6px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .shopping-header, .edit-header {
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .shopping-header {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        }

        .edit-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .shopping-header h2, .edit-header h2 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .shopping-progress {
            margin: 12px 0;
        }

        .shopping-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 12px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1rem;
        }

        .save-button-container {
            text-align: center;
            margin: 25px 0;
            padding: 0 10px;
        }

        .save-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 300px;
            touch-action: manipulation;
        }

        .save-button:active {
            transform: scale(0.95);
        }

        .save-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .finish-shopping-container, .finish-editing-container {
            text-align: center;
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 10px;
        }

        .finish-shopping-btn, .finish-editing-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            touch-action: manipulation;
        }

        .exit-shopping-btn, .exit-editing-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            touch-action: manipulation;
        }

        .finish-shopping-btn:active, .exit-shopping-btn:active,
        .finish-editing-btn:active, .exit-editing-btn:active {
            transform: scale(0.95);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .pulse {
            width: 6px;
            height: 6px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            70% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }

        /* Edit mode styles */
        .edit-mode-controls {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .edit-mode-controls h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .edit-mode-controls p {
            color: #856404;
            font-size: 0.85rem;
            margin: 0;
        }

        /* Responsive */
        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 16px;
            }

            .container {
                border-radius: 10px;
                min-height: calc(100vh - 10px);
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .main-content {
                padding: 12px;
            }

            .categories {
                gap: 15px;
            }

            .category {
                padding: 12px;
            }

            .item {
                padding: 10px;
                min-height: 44px;
            }

            .item-name {
                font-size: 0.9rem;
            }

            .shopping-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                text-align: left;
            }

            .stat {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255,255,255,0.2);
                padding: 8px 12px;
                border-radius: 8px;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            .saved-list-items {
                grid-template-columns: 1fr;
            }

            .list-actions {
                flex-direction: column;
            }

            .delete-list-btn, .shop-list-btn, .edit-list-btn {
                min-width: auto;
            }

            .quantity-btn {
                width: 24px;
                height: 24px;
                font-size: 0.9rem;
            }

            .quantity-display {
                min-width: 28px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Lista de Supermercado Familiar</h1>
            <p>Organizar compras con cantidades - ¬°No olvides nada!</p>
            <div class="connection-status">
                <div class="status-indicator" id="connection-status"></div>
                <span id="connection-text">Conectando...</span>
                <div class="realtime-indicator">
                    <div class="pulse"></div>
                    <span>En tiempo real</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="nav-buttons">
                <button class="btn active touchable" onclick="showSection('new-list')">üìù Nueva Lista</button>
                <button class="btn touchable" onclick="showSection('saved-lists')">üìã Listas Guardadas</button>
            </div>

            <!-- Nueva Lista -->
            <div id="new-list" class="section active">
                <div class="form-group">
                    <label for="list-name">Nombre de la lista:</label>
                    <input type="text" id="list-name" placeholder="Ej: Lista quincenal, Compra para el asado...">
                </div>

                <div class="form-group">
                    <label for="family-member">Creada por:</label>
                    <select id="family-member">
                        <option value="Pap√°">üë® Pap√°</option>
                        <option value="Mam√°">üë© Mam√°</option>
                        <option value="Hijo/a 1">üë¶ Hijo</option>
                        <option value="Hijo/a 2">üëß Hija</option>
                        <option value="Otro">üë§ Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="list-date">Fecha:</label>
                    <input type="date" id="list-date">
                </div>

                <div class="categories" id="categories-container">
                    <!-- Las categor√≠as se generar√°n din√°micamente -->
                </div>

                <div class="save-button-container">
                    <button class="save-button touchable" onclick="saveList()" id="save-btn">
                        üíæ Guardar Lista
                    </button>
                </div>
            </div>

            <!-- Listas Guardadas -->
            <div id="saved-lists" class="section">
                <div id="saved-lists-container">
                    <!-- Las listas guardadas se mostrar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Modo Compra -->
            <div id="shopping-mode" class="section">
                <div class="shopping-header">
                    <h2 id="shopping-list-name">üõí Modo Compra</h2>
                    <div class="shopping-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="shopping-progress"></div>
                        </div>
                    </div>
                    <div class="shopping-stats">
                        <div class="stat">
                            <span class="stat-label">Completados</span>
                            <span class="stat-number" id="completed-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Pendientes</span>
                            <span class="stat-number" id="remaining-count">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Progreso</span>
                            <span class="stat-number" id="progress-percent">0%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Total Items</span>
                            <span class="stat-number" id="total-quantity">0</span>
                        </div>
                    </div>
                </div>

                <div class="categories" id="shopping-categories-container">
                    <!-- Las categor√≠as para modo compra se generar√°n aqu√≠ -->
                </div>

                <div class="finish-shopping-container">
                    <button class="finish-shopping-btn touchable" onclick="finishShopping()">
                        ‚úÖ Finalizar Compra
                    </button>
                    <button class="exit-shopping-btn touchable" onclick="exitShoppingMode()">
                        ‚Üê Volver a Listas
                    </button>
                </div>
            </div>

            <!-- Modo Edici√≥n -->
            <div id="edit-mode" class="section">
                <div class="edit-header">
                    <h2 id="edit-list-name">‚úèÔ∏è Editar Lista</h2>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="edit-list-name-input" style="color: white;">Nombre de la lista:</label>
                        <input type="text" id="edit-list-name-input" style="margin-top: 8px;">
                    </div>
                    <div class="form-group">
                        <label for="edit-family-member" style="color: white;">Editada por:</label>
                        <select id="edit-family-member" style="margin-top: 8px;">
                            <option value="Pap√°">üë® Pap√°</option>
                            <option value="Mam√°">üë© Mam√°</option>
                            <option value="Hijo/a 1">üë¶ Hijo/a 1</option>
                            <option value="Hijo/a 2">üëß Hijo/a 2</option>
                            <option value="Otro">üë§ Otro</option>
                        </select>
                    </div>
                </div>

                <div class="edit-mode-controls">
                    <h4>üéØ Modo Edici√≥n Activado</h4>
                    <p>Puedes agregar nuevos elementos, eliminar existentes con ‚ùå, y cambiar cantidades con + / -</p>
                </div>

                <div class="categories edit-mode" id="edit-categories-container">
                    <!-- Las categor√≠as para modo edici√≥n se generar√°n aqu√≠ -->
                </div>

                <div class="finish-editing-container">
                    <button class="finish-editing-btn touchable" onclick="saveEditedList()">
                        üíæ Guardar Cambios
                    </button>
                    <button class="exit-editing-btn touchable" onclick="exitEditMode()">
                        ‚Üê Cancelar Edici√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd/index.min.js"></script>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://fkbibznxasdkzrrqecul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrYmliem54YXNka3pycnFlY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTUxNDcsImV4cCI6MjA2Njk5MTE0N30.usnm1yQ3dWdjvUHPW3YZmL3WQQJyp6lD3ot8IqmpSwA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variables globales
        let currentShoppingList = null;
        let currentEditingList = null;
        let isConnected = false;

        // Productos por categor√≠a
        const products = {
            dairy: ['Leche', 'Queso', 'Yogur', 'Mantequilla', 'Crema', 'Quesillo', 'Ricotta'],
            meat: ['Pollo', 'Carne molida', 'Bistec', 'Cerdo', 'Pescado', 'Jam√≥n', 'Salchichas'],
            vegetables: ['Tomate', 'Cebolla', 'Ajo', 'Zanahoria', 'Lechuga', 'Pepino', 'Palta'],
            fruits: ['Manzana', 'Pl√°tano', 'Naranja', 'Lim√≥n', 'Frutilla', 'Uva', 'Pera'],
            grains: ['Arroz', 'Pasta', 'Pan', 'Avena', 'Quinoa', 'Lentejas', 'Fideos'],
            beverages: ['Agua', 'Jugo', 'Bebida', 'Caf√©', 'T√©', 'Vino', 'Cerveza'],
            cleaning: ['Detergente', 'Cloro', 'Jab√≥n', 'Papel higi√©nico', 'Shampoo', 'Pasta dental'],
            others: ['Aceite', 'Sal', 'Az√∫car', 'Pilas', 'Medicamentos', 'Condimentos']
        };

        const categoryNames = {
            dairy: 'ü•õ L√°cteos',
            meat: 'ü•© Carnes',
            vegetables: 'ü•¨ Vegetales',
            fruits: 'üçé Frutas',
            grains: 'üåæ Granos',
            beverages: 'ü•§ Bebidas',
            cleaning: 'üßΩ Limpieza',
            others: 'üì¶ Otros'
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkConnection();
            setInterval(checkConnection, 30000); // Verificar conexi√≥n cada 30 segundos
        });

        async function initializeApp() {
            // Establecer fecha actual
            document.getElementById('list-date').value = new Date().toISOString().split('T')[0];
            
            // Generar categor√≠as
            generateCategories();
            
            // Cargar listas guardadas
            await loadSavedLists();
            
            // Configurar realtime
            setupRealtimeSubscription();
        }

        async function checkConnection() {
            try {
                const { data, error } = await supabase.from('shopping_lists').select('id').limit(1);
                updateConnectionStatus(true);
                isConnected = true;
            } catch (error) {
                updateConnectionStatus(false);
                isConnected = false;
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                text.textContent = 'Conectado';
            } else {
                indicator.classList.add('disconnected');
                text.textContent = 'Sin conexi√≥n';
            }
        }

        function setupRealtimeSubscription() {
            supabase
                .channel('shopping_lists')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'shopping_lists' },
                    (payload) => {
                        console.log('Cambio detectado:', payload);
                        loadSavedLists();
                    }
                )
                .subscribe();
        }

        function generateCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            Object.entries(products).forEach(([category, items]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category ${category}`;
                categoryDiv.innerHTML = `
                    <h3>${categoryNames[category]}</h3>
                    <div class="category-items">
                        ${items.map(item => `
                            <div class="item" data-category="${category}" data-name="${item}">
                                <input type="checkbox" class="item-checkbox" onchange="toggleItem(this)">
                                <span class="item-name">${item}</span>
                                <div class="item-quantity-controls">
                                    <button class="quantity-btn" onclick="changeQuantity(this, -1)">‚àí</button>
                                    <span class="quantity-display">1</span>
                                    <button class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                                </div>
                                <span class="item-status">üìã</span>
                                <button class="item-remove" onclick="removeItem(this)">√ó</button>
                            </div>
                        `).join('')}
                        <div class="add-custom-item">
                            <input type="text" placeholder="Agregar producto personalizado..." onkeypress="addCustomItemOnEnter(event, '${category}')">
                            <button onclick="addCustomItem(this, '${category}')">+</button>
                        </div>
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        function showSection(sectionId, button = null) {
        // Ocultar todas las secciones
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });

        // Remover clase active de todos los botones
        document.querySelectorAll('.btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Mostrar secci√≥n seleccionada
        document.getElementById(sectionId).classList.add('active');

        // Activar bot√≥n correspondiente si existe
        if (button) {
            button.classList.add('active');
        }


            // Cargar datos espec√≠ficos de la secci√≥n
            if (sectionId === 'saved-lists') {
                loadSavedLists();
            }
        }

        function toggleItem(checkbox) {
            const item = checkbox.closest('.item');
            
            if (checkbox.checked) {
                item.classList.add('selected');
                item.querySelector('.item-status').textContent = '‚úÖ';
            } else {
                item.classList.remove('selected');
                item.querySelector('.item-status').textContent = 'üìã';
            }
        }

        function changeQuantity(button, change) {
            const quantityDisplay = button.parentElement.querySelector('.quantity-display');
            let currentQuantity = parseInt(quantityDisplay.textContent);
            let newQuantity = Math.max(1, currentQuantity + change);
            quantityDisplay.textContent = newQuantity;
        }

        function removeItem(button) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
                button.closest('.item').remove();
            }
        }

        function addCustomItemOnEnter(event, category) {
            if (event.key === 'Enter') {
                addCustomItem(event.target.nextElementSibling, category);
            }
        }

        function addCustomItem(button, category) {
            const input = button.previousElementSibling;
            const itemName = input.value.trim();
            
            if (itemName) {
                const categoryDiv = button.closest('.category');
                const itemsContainer = categoryDiv.querySelector('.category-items');
                const addItemDiv = categoryDiv.querySelector('.add-custom-item');
                
                const newItemDiv = document.createElement('div');
                newItemDiv.className = 'item';
                newItemDiv.setAttribute('data-category', category);
                newItemDiv.setAttribute('data-name', itemName);
                newItemDiv.innerHTML = `
                    <input type="checkbox" class="item-checkbox" onchange="toggleItem(this)">
                    <span class="item-name">${itemName}</span>
                    <div class="item-quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity(this, -1)">‚àí</button>
                        <span class="quantity-display">1</span>
                        <button class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                    </div>
                    <span class="item-status">üìã</span>
                    <button class="item-remove" onclick="removeItem(this)">√ó</button>
                `;
                
                itemsContainer.insertBefore(newItemDiv, addItemDiv);
                input.value = '';
            }
        }

        async function saveList() {
            const listName = document.getElementById('list-name').value.trim();
            const familyMember = document.getElementById('family-member').value;
            const listDate = document.getElementById('list-date').value;
            
            if (!listName) {
                alert('Por favor ingresa un nombre para la lista');
                return;
            }
            
            const selectedItems = [];
            document.querySelectorAll('.item input[type="checkbox"]:checked').forEach(checkbox => {
                const item = checkbox.closest('.item');
                const itemData = {
                    name: item.dataset.name,
                    category: item.dataset.category,
                    quantity: parseInt(item.querySelector('.quantity-display').textContent),
                    completed: false
                };
                selectedItems.push(itemData);
            });
            
            if (selectedItems.length === 0) {
                alert('Por favor selecciona al menos un producto');
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="loading"></div> Guardando...';
            
            try {
                const { data, error } = await supabase
                    .from('shopping_lists')
                    .insert([{
                        name: listName,
                        created_by: familyMember,
                        list_date: listDate,
                        items: selectedItems,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                alert('¬°Lista guardada exitosamente!');
                clearForm();
                await loadSavedLists();
                showSection('saved-lists');
                
            } catch (error) {
                console.error('Error guardando lista:', error);
                alert('Error al guardar la lista. Por favor intenta de nuevo.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'üíæ Guardar Lista';
            }
        }

        function clearForm() {
            document.getElementById('list-name').value = '';
            document.getElementById('list-date').value = new Date().toISOString().split('T')[0];
            
            // Deseleccionar todos los items y resetear cantidades
            document.querySelectorAll('.item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
                item.classList.remove('selected');
                item.querySelector('.item-status').textContent = 'üìã';
                item.querySelector('.quantity-display').textContent = '1';
            });
        }

        async function loadSavedLists() {
            const container = document.getElementById('saved-lists-container');
            
            try {
                const { data: lists, error } = await supabase
                    .from('shopping_lists')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (lists.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üìù No hay listas guardadas</h3>
                            <p>Crea tu primera lista de compras para comenzar</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = lists.map(list => {
                    const totalItems = list.items.length;
                    const completedItems = list.items.filter(item => item.completed).length;
                    const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                    
                    return `
                        <div class="saved-list">
                            <h3>${list.name}</h3>
                            <div class="saved-list-meta">
                                üìÖ ${new Date(list.list_date).toLocaleDateString('es-ES')} ‚Ä¢ 
                                üë§ ${list.created_by} ‚Ä¢ 
                                üì¶ ${totalItems} productos
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="saved-list-items">
                                ${list.items.slice(0, 6).map(item => `
                                    <div class="saved-item ${item.completed ? 'completed' : ''}">
                                        <span>${item.name}</span>
                                        <span class="saved-item-quantity">${item.quantity}</span>
                                    </div>
                                `).join('')}
                                ${list.items.length > 6 ? `<div class="saved-item">... y ${list.items.length - 6} m√°s</div>` : ''}
                            </div>
                            <div class="list-actions">
                                <button class="shop-list-btn touchable" onclick="startShopping('${list.id}')">üõí Comprar</button>
                                <button class="edit-list-btn touchable" onclick="editList('${list.id}')">‚úèÔ∏è Editar</button>
                                <button class="delete-list-btn touchable" onclick="deleteList('${list.id}')">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error cargando listas:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Error al cargar listas</h3>
                        <p>No se pudieron cargar las listas guardadas</p>
                    </div>
                `;
            }
        }

        async function deleteList(listId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta lista?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('shopping_lists')
                    .delete()
                    .eq('id', listId);
                
                if (error) throw error;
                
                await loadSavedLists();
            } catch (error) {
                console.error('Error eliminando lista:', error);
                alert('Error al eliminar la lista');
            }
        }

        async function startShopping(listId) {
            try {
                const { data: list, error } = await supabase
                    .from('shopping_lists')
                    .select('*')
                    .eq('id', listId)
                    .single();
                
                if (error) throw error;
                
                currentShoppingList = list;
                setupShoppingMode();
                showShoppingSection();
                
            } catch (error) {
                console.error('Error iniciando compra:', error);
                alert('Error al iniciar modo compra');
            }
        }

        function setupShoppingMode() {
            const listNameElement = document.getElementById('shopping-list-name');
            listNameElement.textContent = `üõí ${currentShoppingList.name}`;
            
            generateShoppingCategories();
            updateShoppingStats();
        }

        function generateShoppingCategories() {
            const container = document.getElementById('shopping-categories-container');
            container.innerHTML = '';
            
            // Agrupar items por categor√≠a
            const itemsByCategory = {};
            currentShoppingList.items.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });
            
            Object.entries(itemsByCategory).forEach(([category, items]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category ${category}`;
                categoryDiv.innerHTML = `
                    <h3>${categoryNames[category]}</h3>
                    <div class="category-items">
                        ${items.map((item, index) => `
                            <div class="item ${item.completed ? 'completed' : ''}" data-item-index="${currentShoppingList.items.indexOf(item)}">
                                <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''} onchange="toggleShoppingItem(this)">
                                <span class="item-name">${item.name}</span>
                                <div class="item-quantity-controls">
                                    <span class="quantity-display">${item.quantity}</span>
                                </div>
                                <span class="item-status">${item.completed ? '‚úÖ' : 'üõí'}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        async function toggleShoppingItem(checkbox) {
            const item = checkbox.closest('.item');
            const itemIndex = parseInt(item.dataset.itemIndex);
            
            currentShoppingList.items[itemIndex].completed = checkbox.checked;
            
            if (checkbox.checked) {
                item.classList.add('completed');
                item.querySelector('.item-status').textContent = '‚úÖ';
            } else {
                item.classList.remove('completed');
                item.querySelector('.item-status').textContent = 'üõí';
            }
            
            updateShoppingStats();
            
            // Guardar cambios en la base de datos
            try {
                await supabase
                    .from('shopping_lists')
                    .update({ items: currentShoppingList.items })
                    .eq('id', currentShoppingList.id);
            } catch (error) {
                console.error('Error actualizando item:', error);
            }
        }

        function updateShoppingStats() {
            const totalItems = currentShoppingList.items.length;
            const completedItems = currentShoppingList.items.filter(item => item.completed).length;
            const remainingItems = totalItems - completedItems;
            const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            const totalQuantity = currentShoppingList.items.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('completed-count').textContent = completedItems;
            document.getElementById('remaining-count').textContent = remainingItems;
            document.getElementById('progress-percent').textContent = `${progress}%`;
            document.getElementById('total-quantity').textContent = totalQuantity;
            document.getElementById('shopping-progress').style.width = `${progress}%`;
        }

        function showShoppingSection() {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar modo compra
            document.getElementById('shopping-mode').classList.add('active');
            
            // Actualizar botones de navegaci√≥n
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active', 'shopping-mode');
            });
            
            // Crear bot√≥n temporal de modo compra si no existe
            const navButtons = document.querySelector('.nav-buttons');
            let shoppingBtn = navButtons.querySelector('.shopping-mode-btn');
            if (!shoppingBtn) {
                shoppingBtn = document.createElement('button');
                shoppingBtn.className = 'btn shopping-mode shopping-mode-btn active';
                shoppingBtn.innerHTML = 'üõí Modo Compra';
                shoppingBtn.onclick = () => showShoppingSection();
                navButtons.appendChild(shoppingBtn);
            } else {
                shoppingBtn.classList.add('active');
            }
        }

        async function finishShopping() {
            if (!confirm('¬øFinalizar compra? Esto marcar√° la lista como completada. LUEGO NO QUIERO EN LA CASA DICIENDO QUE LES FALTO ALGO!')) {
                return;
            }
            
            try {
                await supabase
                    .from('shopping_lists')
                    .update({ 
                        completed: true,
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', currentShoppingList.id);
                
                alert('¬°Compra finalizada exitosamente!');
                exitShoppingMode();
                
            } catch (error) {
                console.error('Error finalizando compra:', error);
                alert('Error al finalizar compra');
            }
        }

        function exitShoppingMode() {
            currentShoppingList = null;
            
            // Remover bot√≥n de modo compra
            const shoppingBtn = document.querySelector('.shopping-mode-btn');
            if (shoppingBtn) {
                shoppingBtn.remove();
            }
            
            // Volver a listas guardadas
            showSection('saved-lists');
            loadSavedLists();
        }

        async function editList(listId) {
            try {
                const { data: list, error } = await supabase
                    .from('shopping_lists')
                    .select('*')
                    .eq('id', listId)
                    .single();
                
                if (error) throw error;
                
                currentEditingList = list;
                setupEditMode();
                showEditSection();
                
            } catch (error) {
                console.error('Error iniciando edici√≥n:', error);
                alert('Error al iniciar modo edici√≥n');
            }
        }

        function setupEditMode() {
            document.getElementById('edit-list-name').textContent = `‚úèÔ∏è ${currentEditingList.name}`;
            document.getElementById('edit-list-name-input').value = currentEditingList.name;
            document.getElementById('edit-family-member').value = currentEditingList.created_by;
            
            generateEditCategories();
        }

        function generateEditCategories() {
            const container = document.getElementById('edit-categories-container');
            container.innerHTML = '';
            
            Object.entries(products).forEach(([category, defaultItems]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category ${category}`;
                
                // Obtener items existentes de esta categor√≠a
                const existingItems = currentEditingList.items.filter(item => item.category === category);
                
                // Combinar items por defecto con items existentes
                const allItems = [...defaultItems];
                existingItems.forEach(existingItem => {
                    if (!allItems.includes(existingItem.name)) {
                        allItems.push(existingItem.name);
                    }
                });
                
                categoryDiv.innerHTML = `
                    <h3>${categoryNames[category]}</h3>
                    <div class="category-items">
                        ${allItems.map(itemName => {
                            const existingItem = existingItems.find(item => item.name === itemName);
                            const isSelected = !!existingItem;
                            const quantity = existingItem ? existingItem.quantity : 1;
                            
                            return `
                                <div class="item ${isSelected ? 'selected' : ''}" data-category="${category}" data-name="${itemName}">
                                    <input type="checkbox" class="item-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItem(this)">
                                    <span class="item-name">${itemName}</span>
                                    <div class="item-quantity-controls">
                                        <button class="quantity-btn" onclick="changeQuantity(this, -1)">‚àí</button>
                                        <span class="quantity-display">${quantity}</span>
                                        <button class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                                    </div>
                                    <span class="item-status">${isSelected ? '‚úÖ' : 'üìã'}</span>
                                    <button class="item-remove" onclick="removeItem(this)">√ó</button>
                                </div>
                            `;
                        }).join('')}
                        <div class="add-custom-item">
                            <input type="text" placeholder="Agregar producto personalizado..." onkeypress="addCustomItemOnEnter(event, '${category}')">
                            <button onclick="addCustomItem(this, '${category}')">+</button>
                        </div>
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        function showEditSection() {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar modo edici√≥n
            document.getElementById('edit-mode').classList.add('active');
            
            // Actualizar botones de navegaci√≥n
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active', 'edit-mode');
            });
            
            // Crear bot√≥n temporal de modo edici√≥n si no existe
            const navButtons = document.querySelector('.nav-buttons');
            let editBtn = navButtons.querySelector('.edit-mode-btn');
            if (!editBtn) {
                editBtn = document.createElement('button');
                editBtn.className = 'btn edit-mode edit-mode-btn active';
                editBtn.innerHTML = '‚úèÔ∏è Modo Edici√≥n';
                editBtn.onclick = () => showEditSection();
                navButtons.appendChild(editBtn);
            } else {
                editBtn.classList.add('active');
            }
        }

        async function saveEditedList() {
            const listName = document.getElementById('edit-list-name-input').value.trim();
            const familyMember = document.getElementById('edit-family-member').value;
            
            if (!listName) {
                alert('Por favor ingresa un nombre para la lista');
                return;
            }
            
            const selectedItems = [];
            document.querySelectorAll('#edit-mode .item input[type="checkbox"]:checked').forEach(checkbox => {
                const item = checkbox.closest('.item');
                const itemData = {
                    name: item.dataset.name,
                    category: item.dataset.category,
                    quantity: parseInt(item.querySelector('.quantity-display').textContent),
                    completed: false
                };
                selectedItems.push(itemData);
            });
            
            if (selectedItems.length === 0) {
                alert('Por favor selecciona al menos un producto');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('shopping_lists')
                    .update({
                        name: listName,
                        created_by: familyMember,
                        items: selectedItems,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentEditingList.id);
                
                if (error) throw error;
                
                alert('¬°Lista actualizada exitosamente!');
                exitEditMode();
                
            } catch (error) {
                console.error('Error actualizando lista:', error);
                alert('Error al actualizar la lista');
            }
        }

        function exitEditMode() {
            currentEditingList = null;
            
            // Remover bot√≥n de modo edici√≥n
            const editBtn = document.querySelector('.edit-mode-btn');
            if (editBtn) {
                editBtn.remove();
            }
            
            // Volver a listas guardadas
            showSection('saved-lists');
            loadSavedLists();
        }

        // Funciones de utilidad para touch
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('touchable')) {
                e.target.style.transform = 'scale(0.95)';
            }
        });

        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('touchable')) {
                setTimeout(() => {
                    e.target.style.transform = '';
                }, 150);
            }
        });

        // Prevenir zoom en doble tap
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        let lastTouchEnd = 0;
    </script>
</body>
</html>
